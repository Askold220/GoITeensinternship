//@version=4
study(title="Order Blocks Indicator", overlay=true)

// Your settings
range_value = input(15, title="Candle Range", minval=5, maxval=100)

var float structureLow = na
var int structureLowIndex = 0
var float lastDown = 0
var float lastLow = 0
var int lastDownIndex = 0
var float lastUp = 0
var float lastUpLow = 0
var float lastUpOpen = 0
var float lastHigh = 0
var float lastBullBreakLow = 0
var int lastLongIndex = 0
var int lastShortIndex = 0

var bool BosCandle = false
var int CandleColourMode = 0

// Order block drawing arrays
var float[] shortBoxes = array.new_float(na)
var float[] longBoxes = array.new_float(na)

PDH = request.security(syminfo.tickerid, "D", high[1])
PDL = request.security(syminfo.tickerid, "D", low[1])

// Identify blocks
structureLowIndexPointer(len) =>
    float minValue = highest(high, len)[1]
    int minIndex = bar_index
    for i = 1 to len
        if low[i] < minValue
            minValue := low[i]
            minIndex := bar_index[i]
    minIndex

structureLow := lowest(low, range_value)[1]
structureLowIndex := structureLowIndexPointer(range_value)

// Bearish break of structure
if (crossunder(low, structureLow))
    if ((bar_index - lastUpIndex) < 1000)
        // add bear order block
        array.push(shortBoxes, structureLow)
        // show bos candle
        BosCandle := true
        // color mode bear
        CandleColourMode := 0
        lastShortIndex := lastUpIndex

// Bullish break of structure?
if (array.size(shortBoxes) > 0)
    for i = (array.size(shortBoxes) - 1) to 0
        box = array.get(shortBoxes, i)
        top = box
        left = bar_index[box]
        // remove the short box
        array.remove(shortBoxes, i)
        // ok to draw?
        if ((bar_index - lastDownIndex) < 1000 and bar_index > lastLongIndex)
            // add bullish order block
            array.push(longBoxes, lastDown)
            // show bos candle
            BosCandle := true
            // colour mode bullish
            CandleColourMode := 1
            // record last bull bar index to prevent duplication
            lastLongIndex := bar_index
            lastBullBreakLow := low

// remove LL if close below
if (array.size(longBoxes) > 0)
    for i = (array.size(longBoxes) - 1) to 0
        // remove the long box
        array.remove(longBoxes, i)

// candle coloring
CandleColour = CandleColourMode == 1 ? color.new(color.green, 90) : color.new(color.red, 90)
CandleColour := BosCandle ? color.new(color.yellow, 90) : CandleColour
bgcolor(CandleColour)
